extends layout

block styles
	link(rel='stylesheet', href='/css/bootstrap.min.css')

block scripts
	script(src='/js/lib/bootstrap.js')
	script(src='http://code.jquery.com/jquery.js')
	script(src='http://static.ak.fbcdn.net/connect/en_US/core.js')

block content
	div(id="fb-root")
	script(type='text/javascript')
		window.fbAsyncInit = function() {
			// init the FB JS SDK
			FB.init({
			appId      : '576850129012966',                        // App ID from the app dashboard
			channelUrl : 'http://arcane-atoll-7643.herokuapp.com/channel.html', // Channel file for x-domain comms
			status     : true,                                 // Check Facebook Login status
			xfbml      : true                                  // Look for social plugins on the page
			});

		FB.Event.subscribe('auth.authResponseChange', function(response) {
			// Here we specify what we do with the response anytime this event occurs. 
			if (response.status === 'connected') {
				testAPI();
			} else if (response.status === 'not_authorized') {
				FB.login();
			} else {
				FB.login();
			}
		});

		console.log(#{isLoggedIn});
		};
		
		// Load the SDK asynchronously
		(function(d){
			var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
			if (d.getElementById(id)) {return;}
			js = d.createElement('script'); js.id = id; js.async = true;
			js.src = "//connect.facebook.net/en_US/all.js";
			ref.parentNode.insertBefore(js, ref);
		}(document));

		// Here we run a very simple test of the Graph API after login is successful. 
		// This testAPI() function is only called in those cases. 
		function testAPI() {
			console.log('Welcome!  Fetching your information.... ');
			FB.api('/me', function(response) {
				console.log('Good to see you, ' + response.name + '.');
				$('#hello').innerHTML = "'Good to see you, ' + response.name + '.'";

				$.ajax({
					url: "/user",
					type: "POST",
					data: { "name": response.name, "id": response.id},
					dataType: "json",
					success: function (result) {
						switch (result) {
							case true:
								console.log("Successful data POST");
								window.location = "/login";
								break;
							default:
								//resultDiv.html(result);
						}
					},
					error: function (xhr, ajaxOptions, thrownError) {
						alert(xhr.status);
						alert(thrownError);
					}
				});

				
			});
		}

		function login() {
			// @TODO: Comment this line out and uncomment the rest!
			//window.location = "/login";

			FB.login(function(response) {
				if (response.authResponse) {
					// connected
					testAPI();
			
				} else {
					// cancelled
				}
			});
		}

	if(isLoggedIn==false)
		div(class='hero-unit pagination-centered')
			h1= title
			p A simple music sharing app made for everyone
			button(onclick = "login();", class='btn-large btn-primary') Login via Facebook
			//fb:login-button(show-faces="true" width="200" max-rows="1")
	else
		div
			p(id="hello") Test